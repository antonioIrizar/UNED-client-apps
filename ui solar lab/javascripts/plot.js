// Generated by CoffeeScript 1.8.0
(function() {
  var Plot,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Plot = (function() {
    Plot.prototype.resizeActive = null;

    Plot.prototype.dataPlot = null;

    Plot.prototype.options = null;

    Plot.prototype.chart = null;

    Plot.prototype.time = 0;

    Plot.prototype.alarma = null;

    Plot.prototype.options1 = null;

    Plot.prototype.initChart = false;

    Plot.prototype.data = [[]];

    Plot.prototype.realTime = null;

    Plot.prototype.inputCurrent = null;

    Plot.prototype.inputVoltage = null;

    Plot.prototype.workToDo = null;

    Plot.prototype.stop = true;

    Plot.prototype.experiments = [];

    Plot.prototype.timeStart = null;

    function Plot() {
      this.saveArrayData = __bind(this.saveArrayData, this);
      this.experiments = [];
      this.data = [[]];
      this.chart = new google.visualization.LineChart(document.getElementById('chart_div'));
      this.stop = true;
      google.setOnLoadCallback(this.drawChart());

      /*
      window.addEventListener "resize", =>
          if @resizeActive 
              clearTimeout(@resizeActive)
          @resizeActive = setTimeout( =>
              @resize()
              @chart.draw(@dataPlot, @options)
          ,500)
       */
    }

    Plot.prototype.resize = function() {
      var height, margin;
      if (window.innerWidth >= 1200) {
        height = document.getElementById("div_formula_col").offsetHeight - document.getElementById("webcam").offsetHeight - 90;
        height = height - 20;
        this.options = {
          chartArea: {
            left: 40,
            top: 20,
            height: height - 50,
            width: "100%"
          },
          legend: {
            position: 'none'
          },
          series: {
            0: {
              color: "red"
            },
            1: {
              color: "green"
            },
            2: {
              color: "blue"
            }
          }
        };
      } else {
        height = 250;
        this.options = {
          chartArea: {
            left: 40,
            top: 20,
            height: "200",
            width: "100%"
          },
          legend: {
            position: 'none'
          },
          series: {
            0: {
              color: "red"
            },
            1: {
              color: "green"
            },
            2: {
              color: "blue"
            }
          }
        };
      }
      if (window.innerWidth < 760) {
        margin = Math.round((760 - window.innerWidth) * 0.12);
        document.getElementById("legend").setAttribute("style", "margin-left: -" + margin + "px");
      } else {
        document.getElementById("legend").removeAttribute("style");
      }
      document.getElementById("chart_div").setAttribute("style", "height:" + height + "px");
      return this.chart.draw(this.dataPlot, this.options);
    };

    Plot.prototype.resizeEvent = function(esd) {
      var a, b, d;
      esd.drawImageInCanvas();
      this.resize();
      if (this.initChart) {
        if (this.time > 18) {
          this.dataPlot.removeRow(17);
        } else {
          this.dataPlot.removeRow(this.time - 2);
        }
        this.chart.draw(this.dataPlot, this.options);
        this.dataPlot.addRow([this.data[this.time - 2][0], parseFloat(this.data[this.time - 2][1]), parseFloat(this.data[this.time - 2][2]), parseFloat(this.data[this.time - 2][3])]);
        d = new Date();
        b = d.getTime();
        a = this.realTime + (1000 * (this.time - 2) * 5) - b;
        if (a > 0) {
          this.options1 = {
            chartArea: {
              left: 40,
              top: 20,
              height: "80%",
              width: "100%"
            },
            legend: {
              position: 'none'
            },
            animation: {
              duration: a,
              easing: 'linear'
            },
            series: {
              0: {
                color: "red"
              },
              1: {
                color: "green"
              },
              2: {
                color: "blue"
              }
            }
          };
        } else {
          this.options1 = {
            chartArea: {
              left: 40,
              top: 20,
              height: "80%",
              width: "100%"
            },
            legend: {
              position: 'none'
            },
            animation: {
              duration: 1,
              easing: 'linear'
            },
            series: {
              0: {
                color: "red"
              },
              1: {
                color: "green"
              },
              2: {
                color: "blue"
              }
            }
          };
        }
        return this.chart.draw(this.dataPlot, this.options1);
      }
    };

    Plot.prototype.drawChart = function() {
      this.dataPlot = google.visualization.arrayToDataTable([['Time', 'Amps', 'Volts', 'Joules'], ['0', 0.000, 0.000, 0.000]]);
      this.data[this.time] = ['0', '0.0000', '0.0000', '0'];
      this.time++;
      this.options = {
        chartArea: {
          left: 40,
          top: 20,
          height: "80%",
          width: "100%"
        },
        legend: {
          position: 'none'
        },
        series: {
          0: {
            color: "red"
          },
          1: {
            color: "green"
          },
          2: {
            color: "blue"
          }
        }
      };
      this.chart.draw(this.dataPlot, this.options);
      return google.visualization.events.addListener(this.chart, 'animationfinish', (function(_this) {
        return function() {
          console.log("dentro del lisenet");
          if (!_this.stop) {
            if (_this.time > 18) {
              _this.dataPlot.removeRow(0);
            }
            _this.data[_this.time] = ['' + _this.time, _this.inputCurrent, _this.inputVoltage, _this.workToDo];
            _this.dataPlot.addRow(['' + _this.time, parseFloat(_this.inputCurrent), parseFloat(_this.inputVoltage), parseFloat(_this.workToDo)]);
            _this.time++;
            _this.options1 = {
              chartArea: {
                left: 40,
                top: 20,
                height: "80%",
                width: "100%"
              },
              legend: {
                position: 'none'
              },
              animation: {
                duration: 1900,
                easing: 'linear'
              },
              series: {
                0: {
                  color: "red"
                },
                1: {
                  color: "green"
                },
                2: {
                  color: "blue"
                }
              }
            };
            return _this.chart.draw(_this.dataPlot, _this.options1);
          }
        };
      })(this));
    };

    Plot.prototype.init = function() {
      this.timeStart = new Date().toUTCString();
      this.data[this.time] = ['' + this.time, this.inputCurrent, this.inputVoltage, this.workToDo];
      this.dataPlot.addRow(['' + this.time, parseFloat(this.inputCurrent), parseFloat(this.inputVoltage), parseFloat(this.workToDo)]);
      this.time++;
      this.options1 = {
        chartArea: {
          left: 40,
          top: 20,
          height: "80%",
          width: "100%"
        },
        legend: {
          position: 'none'
        },
        animation: {
          duration: 900,
          easing: 'linear'
        },
        series: {
          0: {
            color: "red"
          },
          1: {
            color: "green"
          },
          2: {
            color: "blue"
          }
        }
      };
      return this.chart.draw(this.dataPlot, this.options1);
    };

    Plot.prototype.reset = function(text) {
      this.saveArrayData(text);
      this.time = 0;
      this.data = [[]];
      this.chart.clearChart();
      return google.setOnLoadCallback(this.drawChart());
    };

    Plot.prototype.saveArrayData = function(text) {
      var aux;
      aux = {
        timeStart: this.timeStart,
        timeFinish: new Date().toUTCString(),
        data: this.data,
        result: text
      };
      return this.experiments.push(aux);
    };

    Plot.prototype.save = function() {
      $('#example1').handsontable({
        data: this.data,
        colHeaders: ["Time", "Amps", "Volts", "Jouls"],
        maxCols: 4,
        maxRows: 4,
        columns: [
          {
            readOnly: true
          }, {
            readOnly: true
          }, {
            readOnly: true
          }, {
            readOnly: true
          }
        ]
      });
      return $('#myModalCSV').modal('show');
    };

    Plot.prototype.saveTextAsFile = function() {
      var data, dataText, downloadLink, fileNameToSaveAs, i, ie, ie11, information, j, length, line, number, textFileAsBlob, textToWrite, _i, _j, _len, _len1, _ref, _ref1;
      length = this.experiments.length;
      textToWrite = 'Report experiments \n\nYou have made ' + length + ' experiments. You can see the results for each of them in this document. \n';
      _ref = this.experiments;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        information = _ref[i];
        number = i + 1;
        textToWrite = textToWrite + '\nExperiment ' + number + ' was executed at ' + information.timeStart + ' and finish at ' + information.timeFinish + '.\n' + information.result + '\n\t* Data generate during the experiment were following:\n';
        line = '\t\t ----------------------------------\n';
        textToWrite = textToWrite + line + '\t\t| Time |  Amps  |  Volts  |  Jouls |\n' + line;
        _ref1 = information.data;
        for (j = _j = 0, _len1 = _ref1.length; _j < _len1; j = ++_j) {
          data = _ref1[j];
          switch (data[0].length) {
            case 1:
              dataText = '\t\t|   ' + j + '  | ';
              break;
            case 2:
              dataText = '\t\t|  ' + j + '  | ';
              break;
            case 3:
              dataText = '\t\t| ' + j + '  | ';
              break;
            case 4:
              dataText = '\t\t| ' + j + ' | ';
          }
          dataText = dataText + data[1] + ' | ' + data[2];
          switch (data[3].length) {
            case 1:
              dataText = dataText + '  |    ' + data[3] + '   |\n';
              break;
            case 2:
              dataText = dataText + '  |   ' + data[3] + '   |\n';
              break;
            case 3:
              dataText = dataText + '  |  ' + data[3] + '   |\n';
          }
          textToWrite = textToWrite + dataText + line;
        }
      }
      textFileAsBlob = new Blob([textToWrite], {
        type: 'text/plain'
      });
      fileNameToSaveAs = document.getElementById("inputNameOfFile").value + ".txt";
      ie = navigator.userAgent.match(/MSIE\s([\d.]+)/);
      ie11 = navigator.userAgent.match(/Trident\/7.0/) && navigator.userAgent.match(/rv:11/);
      if (ie || ie11) {
        return window.navigator.msSaveBlob(textFileAsBlob, fileNameToSaveAs);
      } else {
        downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL !== void 0) {
          downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        } else {
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = this.destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);
        }
        return downloadLink.click();
      }
    };

    Plot.prototype.destroyClickedElement = function(event) {
      return document.body.removeChild(event.target);
    };

    return Plot;

  })();

  window.Plot = Plot;

}).call(this);
