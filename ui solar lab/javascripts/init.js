// Generated by CoffeeScript 1.8.0
(function() {
  var Init,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Init = (function() {
    Init.prototype.plot = null;

    Init.prototype.resizeActive = null;

    Init.prototype.esd = null;

    Init.prototype.solar = null;

    Init.prototype.crane = null;

    Init.prototype.common = null;

    Init.prototype.wsData = null;

    Init.prototype.wsCamera = null;

    Init.prototype.charge = null;

    function Init(idCanvas, img) {
      this.startExperiments = __bind(this.startExperiments, this);
      this.eventReadyAll = __bind(this.eventReadyAll, this);
      this.selectInterface = __bind(this.selectInterface, this);
      this.selectDischarge = __bind(this.selectDischarge, this);
      this.selectCharge = __bind(this.selectCharge, this);
      this.stopFalse = __bind(this.stopFalse, this);
      this.stopTrue = __bind(this.stopTrue, this);
      this.resize = __bind(this.resize, this);
      var token;
      document.addEventListener('selectInterface', this.selectInterface, false);
      document.addEventListener('allWsAreReady', this.eventReadyAll, false);
      token = Math.random();
      this.wsData = new WebsocketData(token);
      this.wsCamera = new WebSocketCamera(token);
      this.plot = new Plot();
      this.esd = new Esd(idCanvas, img);

      /* stop working in firefox
      window.addEventListener "resize", => 
          console.log "mierda puta"
          if @resizeActive 
              clearTimeout(@resizeActive)
          @resizeActive = setTimeout( =>
              @plot.resizeEvent(@esd)
              console.log "resize"
          , 250)
       */
      window.onresize = this.resize;
    }

    Init.prototype.changeNumbers = function(inputCurrent, inputVoltage, workToDo) {
      this.esd.drawText(inputCurrent, inputVoltage, workToDo);
      this.plot.inputCurrent = inputCurrent;
      this.plot.inputVoltage = inputVoltage;
      this.plot.workToDo = workToDo;
      if (this.plot.initChart === false) {
        console.log("iniciando");
        this.plot.initChart = true;
        this.plot.init();
      }
      if (this.plot.stop) {
        return this.plot.initChart = false;
      }
    };

    Init.prototype.resize = function() {
      if (this.resizeActive) {
        clearTimeout(this.resizeActive);
      }
      return this.resizeActive = setTimeout((function(_this) {
        return function() {
          var adapt, height;
          adapt = document.getElementById("adaptToHeight");
          if (adapt !== null) {
            height = window.innerHeight - document.getElementById("panel-elements").offsetHeight;
            height = height - 20;
            adapt.setAttribute("style", "height:" + height + "px");
          }
          return _this.plot.resizeEvent(_this.esd);
        };
      })(this), 250);
    };

    Init.prototype.stopTrue = function() {
      return this.plot.stop = true;
    };

    Init.prototype.stopFalse = function() {
      return this.plot.stop = false;
    };

    Init.prototype.selectCharge = function() {
      if (this.common === null) {
        this.common = new CommonElements(this.wsData, true);
      } else {
        this.wsData.sendActuatorChange('CraneLab', "0");
        this.crane.remove();
        delete this.crane;
        document.getElementById('dischargeButton').removeAttribute('disabled');
        this.crane = null;
        this.common.mySwitch(true);
        this.wsData.sendActuatorChange('SolarLab', "1");
      }
      this.solar = new SolarElements(this.wsData);
      this.charge = true;
      this.common.enableSliders();
      this.common.enableStart();
      this.common.disableStop();
      this.common.disableReset();
      this.stopTrue();
      document.getElementById("panelHeadingElements").innerHTML = 'Elements you can interact with: Mode charge';
      return document.getElementById('chargeButton').setAttribute('disabled', 'disabled');
    };

    Init.prototype.selectDischarge = function() {
      if (this.common === null) {
        this.common = new CommonElements(this.wsData, false);
      } else {
        this.wsData.sendActuatorChange('SolarLab', "0");
        this.solar.remove();
        delete this.solar;
        document.getElementById('chargeButton').removeAttribute('disabled');
        this.solar = null;
        this.common.mySwitch(false);
        this.wsData.sendActuatorChange('CraneLab', "1");
      }
      this.crane = new CraneElements(this.wsData);
      this.charge = false;
      this.common.enableSliders();
      this.common.enableStart();
      this.common.disableStop();
      this.common.disableReset();
      this.stopTrue();
      document.getElementById("panelHeadingElements").innerHTML = 'Elements you can interact with: Mode discharge';
      return document.getElementById('dischargeButton').setAttribute('disabled', 'disabled');
    };

    Init.prototype.selectInterface = function(e) {
      var actualBattery, battery, role;
      battery = e.detail.battery;
      role = document.getElementById('yourRole');
      if (battery >= 90) {
        this.selectDischarge();
      } else {
        this.selectCharge();
      }
      if (e.detail.role === 'observer') {
        if (this.charge) {
          this.solar.disable();
        } else {
          this.crane.disable();
        }
        this.common.disable();
        document.getElementById('dischargeButton').setAttribute('disabled', 'disabled');
        document.getElementById('chargeButton').setAttribute('disabled', 'disabled');
        role.appendChild(document.createTextNode('You are mode observer'));
      } else {
        this.common.disableStop();
        this.common.disableReset();
        role.appendChild(document.createTextNode('You are mode controller'));
      }
      $(".slider-battery").val(battery);
      actualBattery = battery;
      $("p#textBattery").text(battery + "%");
      return this.plot.resize();
    };

    Init.prototype.eventReadyAll = function(e) {
      if (this.wsData.wsDataIsReady && this.wsCamera.wsCameraIsReady) {
        return myApp.hidePleaseWait();
      }
    };

    Init.prototype.startExperiments = function() {
      if (this.charge) {
        console.log("cargarrr");
        this.chargeStart();
      } else {
        this.dischargeStart();
      }
      return this.stopFalse();
    };

    Init.prototype.stopExperiment = function() {
      this.wsData.sendActuatorChange('ESD', '0');
      this.stopTrue();
      this.common.enableSliders();
      this.common.enableStart();
      this.common.disableStop();
      if (!this.charge) {
        return this.crane.enable();
      }
    };

    Init.prototype.resetExperiment = function() {
      var horizontalAxis, lumens, verticalAxis;
      if (this.charge) {
        lumens = null;
        $('.slider-lumens').val(0);
        horizontalAxis = null;
        $('.slider-horizontal-axis').val(0);
        verticalAxis = null;
        $('.slider-vertical-axis').val(0);
        $('.slider-time').val(0);
        this.wsData.sendActuatorChange('SolarLab', '0');
        this.wsData.sendActuatorChange('SolarLab', '1');
      } else {
        this.crane.enable();
        this.wsData.sendActuatorChange('CraneLab', '0');
        this.wsData.sendActuatorChange('CraneLab', '1');
      }
      this.common.enableSliders();
      this.common.enableStart();
      this.common.disableStop();
      this.common.disableReset();
      return this.stopTrue();
    };

    Init.prototype.chargeStart = function() {
      var modal, startExperiment;
      if ((lumens === null || lumens === 0) && $(".slider-lumens").val() === 0) {
        return $('#myModalError').modal('show');
      } else {
        modal = false;
        if (lumens !== null && lumens !== $(".slider-lumens").val()) {
          console.log(lumens);
          console.log($(".slider-lumens").val());
          newForm("lumens-axis-form-confirm", "Lumens", $(".slider-lumens").val().toString(), lumens.toString(), "lumens");
          modal = true;
        }
        if (horizontalAxis !== null && horizontalAxis !== $(".slider-horizontal-axis").val()) {
          newForm("horizontal-axis-form-confirm", "Horizontal axis", $(".slider-horizontal-axis").val().toString(), horizontalAxis.toString(), "horizontalAxis");
          modal = true;
        }
        if (verticalAxis !== null && verticalAxis !== $(".slider-vertical-axis").val()) {
          newForm("vertical-axis-form-confirm", "Vertical axis", $(".slider-vertical-axis").val().toString(), verticalAxis.toString(), "verticalAxis");
          modal = true;
        }
        if (modal) {
          return $('#myModalConfirm').modal('show');
        } else {
          startExperiment = true;

          /*
          sendLumens()
          sendHorizontalAxis()
          sendVerticalAxis()
           */
          if (lumens !== $(".slider-lumens").val()) {
            this.solar.sendLumens();
          }
          if (horizontalAxis !== $(".slider-horizontal-axis").val()) {
            this.solar.sendHorizontalAxis();
          }
          if (verticalAxis !== $(".slider-vertical-axis").val()) {
            this.solar.sendVerticalAxis();
          }
          this.common.sendTime();
          this.common.sendJouls();

          /*
          //sendActuatorChange('Sun', $(".slider-lumens").val());
          //sendActuatorChange('Panelrot', $(".slider-horizontal-axis").val());
          //try this line with minus
          //sendActuatorChange('Paneltilt',"-" + $(".slider-vertical-axis").val());
          //sendActuatorChange('ESDJ', $(".slider-battery").val());
          //sendActuatorChange('Elapsed', $(".slider-time").val());
           */
          this.wsData.sendActuatorChange('ESD', "1");
          this.common.disableSliders();
          this.common.disableStart();
          this.common.enableStop();
          return this.common.enableReset();
        }
      }
    };

    Init.prototype.dischargeStart = function() {
      this.crane.sendDistance();
      this.common.sendJoulsToUse();
      this.common.sendTime();
      this.wsData.sendActuatorChange('ESD', "1");
      this.common.disableSliders();
      this.common.disableStart();
      this.common.enableStop();
      return this.common.enableReset();
    };

    return Init;

  })();

  window.Init = Init;

}).call(this);
