<!DOCTYPE html>
<html>
  <head>
    <title>Solar Lab</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <meta charset="utf-8"  />
    <meta content="X-Content-Type-Options=nosniff" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Antonio Jesus Iŕizar López" />
    <meta name="description" content="Solar Laboratory" />
    <style>


      .vertical-align {
        
        display: flex;
        /* only work in ie 11... */
        align-items: center;
        /*need a 1px in right, because the slider not see correctly*/
        padding-right: 1px;
      }

      #myCanvas{
        position: absolute;
        left: 0;
        top: 0;
      }

      .wrapper{
        position: relative;
        padding-bottom: 10px;
      }

      .tooltipe {
      display: block;
      position: absolute;
      border: 1px solid #D9D9D9;
      font: 400 12px/12px Arial;
      border-radius: 3px;
      background: #fff;
      top: -28px;
      padding: 5px;
      left: -4px;
      text-align: center;
      width: 40px;
    }

    .tooltipe strong {
      display: block;
      padding: 2px;
    }

    .slidera {
      padding-top: 30px;
      height: 90px;
    }

    .modal-body {
      font-weight:normal;
    }

    #battery-warning {
        background: #FF4D4D;
    }

    #green {
        background: #03FF25;
    }

    #white {
        background: #F0F0F0;
    }

    #battery-ok{
      background: #3FB8AF;
    }

    .popover{
      width: 150px;
    }

    #save{
      font-size: 160%;
      float:right;
    }

    .button-accept{
      float:right;
    }
  </style>

<link href="css/timeTo.css" type="text/css" rel="stylesheet"/>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <link href="//weblab.ieec.uned.es/golab/ajirizar/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="css/bootstrap-theme.min.css" rel="stylesheet"/>
  <script src="javascripts/bootstrap.min.js"></script>
<script src="javascripts/jquery.timeTo.min.js"></script>

<link rel="stylesheet" media="screen" href="css/handsontable.full.min.css">
 <script src="javascripts/handsontable.full.min.js"></script>
 <link rel="stylesheet" media="screen" href="css/jquery.handsontable.bootstrap.css">
 
 <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="javascripts/jquery.nouislider.all.min.js"></script>
  <link href="css/jquery.nouislider.min.css" rel="stylesheet">
  <link href="css/jquery.nouislider.pips.min.css" rel="stylesheet">
  <script type="text/javascript">
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
  </script>
  <script src="javascripts/plot.js"></script>
  <script src="javascripts/sliders.js"></script>
  <script src="javascripts/esd.js"></script>
  <script src="javascripts/item.js"></script>
  <script src="javascripts/elements.js"></script>
  <script src="javascripts/solarElements.js"></script>
  <script src="javascripts/commonElements.js"></script>
  <script src="javascripts/craneElements.js"></script>
  <script src="javascripts/websocketCamera.js"></script>
  <script src="javascripts/websocketData.js"></script>
  <script src="javascripts/init.js"></script>
  </head>
  <body onload="arranque()">
    <script type="text/javascript">
   var myApp;
myApp = myApp || (function () {
    var pleaseWaitDiv = $('<div class="modal" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h1 id="titleShowModal" class="text-info">Loading...</h1></div><div id="bodyModalShow" class="modal-body"><div id="progressBarModal" class="progress progress-striped active"><div class="progress-bar" style="width: 100%;"></div></div></div></div></div></div>');
    return {
        showPleaseWait: function(text) {
          $("#titleShowModal").removeClass("text-danger");
          $("#titleShowModal").addClass("text-info");
          $("#titleShowModal").html(text);
            pleaseWaitDiv.modal();
        },
        hidePleaseWait: function () {
            pleaseWaitDiv.modal('hide');
        },
        showError: function(title, text){
          $("#titleShowModal").removeClass("text-primary");
          $("#titleShowModal").addClass("text-danger");
          $("#titleShowModal").html(title);
          $("#progressBarModal").remove();
          div = document.createElement('div');
          p = document.createElement('p');
          ptext = document.createTextNode(text);
          p.appendChild(ptext);
          div.appendChild(p);
          document.getElementById("bodyModalShow").appendChild(div);
          pleaseWaitDiv.modal();
        },

    };
    })();
    myApp.showPleaseWait();
</script>
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-4" id="div_formula_col">
          <div id="panel-elements" class="panel panel-primary">
            <div class="panel-heading">
              <h3 id="panelHeadingElements" class="panel-title"></h3>
            </div>
            <div id="tusmuertos" class="panel-body">
              <div id="noCommonElements"></div>
                          
                        <!-- Modal -->
                        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title">TODO</h4>
                              </div>
                              <div class="modal-body">
                                <p>
                                  You can:
                                 </p>
                                  <ol>
                                    <li> Decide the charge you want in the battery. 
                                      <p>
                                        The battery will start charging till it reaches the selected value or you click on the stop button.
                                      </p>
                                    </li>
                                    
                                    <li>
                                      Decide for how long you want to change the battery.
                                      <p>
                                        The battery will charge for the selected lapse of time or till you click on the stop button.
                                      </p>
                                    </li>
                                    
                                    <li>Decide both, the change and the lapse of time.
                                      <p>
                                        The battery will charge till it reaches the first of both: the selected value or the selected lapse of time; or till you clicks on the stop button.
                                      </p>
                                    </li>
                                    
                                    <li>Decide none.
                                      <p>
                                      The battery will charge till it reaches its maximum or till you click on the stop button.
                                      </p>
                                    </li>
                                  </ol>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>

            <div id="elementsCommons"></div>
          

            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="row">
            <div class="col-lg-5">
              <div id="experiment-real-time-data" class="panel panel-info">
                <div class="panel-heading">
                  <h3 class="panel-title">Experiment real time data</h3>
                </div>
                <div class="panel-body ">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="wrapper">
                        <img id="esd" src="images/esd.png" class="img-responsive" alt="esd">
                        <canvas id="myCanvas"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-lg-12">
                      <strong>
                        Select the follow the options:
                      </strong>
                      <a href="#" data-toggle="modal" data-target="#myModal">
                        <span class="glyphicon glyphicon-info-sign"></span>
                      </a>
                      <div style="margin-top: 10px" class="center-block text-center">
                        <button id="chargeButton" type="button" class="btn btn-success" onclick="varInit.selectCharge()">Charging</button>
                        <button id="dischargeButton" type="button" class="btn btn-danger" onclick="varInit.selectDischarge()">Discharging</button>
                      </div>
                      <p id="yourRole"><p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <div class="col-lg-7" >
            <div id="webcam" class="panel panel-success">
              <div class="panel-heading">
                <h3 class="panel-title">Webcam</h3>
              </div>
              <div id="panelGraph" class="panel-body ">
                <!--<img src="http://62.204.201.150:31/snapshot.cgi?&user=userSolar&pwd=&t=" onload='setTimeout(function() {src = src.substring(0, (src.lastIndexOf("t=")+2))+(new Date()).getTime()}, 1)' onerror='setTimeout(function() {src = src.substring(0, (src.lastIndexOf("t=")+2))+(new Date()).getTime()}, 5000)' alt='' class="img-responsive"/>-->
              <!--<img src="images/webcam.JPG" class="img-responsive">      -->
                <img  id="imgCamera" src="" class="img-responsive center-block" alt="webcam in real time from solar lab">
<!--
  src="http://62.204.201.150:31/videostream.cgi?user=userSolar&amp;pwd="
<iframe marginheight="0" marginwidth="0" scrolling="auto" name="main" src="http://62.204.201.150:31/videostream.cgi?user=observer&pwd=" frameborder="0" height="480" width="640"></iframe>-->
              </div>
            </div>
          </div>
        </div>
          <div class="panel panel-info">
            <div class="panel-heading">
              <div id="save">
                <a href="#" data-toggle="modal" data-target="#myModalCSV">
                  <span class="glyphicon glyphicon-eye-open"></span>
                </a>
                <a href="#" data-toggle="modal" data-target="#myModal2">
                  <span class="glyphicon glyphicon-floppy-disk"></span>
                </a>
              </div>
              <h3 class="panel-title">
                Data received 
              </h3>
               
              <!-- Modal -->
              <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                      <h4 class="modal-title">Save data</h4>
                    </div>
                    <div class="modal-body">
                      <form role="form">
                        <div class="form-group">
                          <label for="inputNameOfFile">Name of file</label>
                          <input type="text" class="form-control" id="inputNameOfFile" placeholder="Name of file">
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" onclick="saveTextAsFile()" data-dismiss="modal" class="btn btn-primary">Save</button>
                      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Modal -->
            </div>
            <div class="panel-body">
              <div class="row">
                <div id="chart_div" class="col-lg-10 col-xs-10"></div>
                <div id="legend" class="col-lg-2 col-xs-2">
                  <ul style="list-style-type:square"> 
                    <li style="color:red">Amps</li>
                    <li style="color:green">Volts</li>
                    <li style="color:blue">Joules</li>
                  </ul> 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="myModalCSV" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Save data</h4>
          </div>
          <div id="cacaVaca" class="modal-body">
            <div  style="width: 300px; height: 300px; overflow-x: auto;" class="handsontable" id="example1"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" onclick="saveTextAsFile()" data-dismiss="modal" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModalError" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title text-danger" id="myModalLabel">Error</h4>
          </div>
          <div  class="modal-body">
            <p class="text-danger">Lumens must be higher than 0.</p>
        </div>
      </div>
    </div>
  </div>

    <div class="modal fade" id="myModalConfirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title text-success">Confirm changes</h4>
          </div>
          <div  class="modal-body">
            <p>You have not accepted the changes. Please select the new or the old values and click on <strong>"Accept"</strong>.</p>
            <form id="form-confirm-changes" role="form">
              <div id="div-confirm-changes">
              </div>
            </form>
        </div>
        <div class="modal-footer">
          <button type="submit" onclick="confirmAccept()" data-dismiss="modal" class="btn btn-info">Accept</button>
          <button type="button" onclick="cleanForm()" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

    <script>
    var lumens = null,
      verticalAxis = null,
      horizontalAxis = null,
      varInit = null,
      wsCameraIsReady = false,
      wsIsReady = false,
      startExperiment = false,
      actualBattery = null;
      function arranque(){
  

      varInit = new Init("myCanvas", "esd");

      /*
      setTimeout(function(){
        myApp.hidePleaseWait();
          

      },1000);

      */
    };


  function disableAll(){
    $(".slider-battery").attr('disabled', 'disabled');
    $(".slider-lumens").attr('disabled', 'disabled');
    $(".slider-time").attr('disabled', 'disabled');
    $(".slider-horizontal-axis").attr('disabled', 'disabled');
    $(".slider-vertical-axis").attr('disabled', 'disabled');
    $("#startExperiment").attr('disabled', 'disabled');
    $(".button-accept").attr('disabled', 'disabled');
  };

  function disable(){
    $("#startExperiment").attr('disabled', 'disabled');
    $(".slider-time").attr('disabled', 'disabled');
    $(".slider-battery").attr('disabled', 'disabled');
  }

  function enable(){
    $(".slider-battery").removeAttr('disabled');
    $(".slider-lumens").removeAttr('disabled');
    $(".slider-time").removeAttr('disabled');
    $(".slider-horizontal-axis").removeAttr('disabled');
    $(".slider-vertical-axis").removeAttr('disabled');
    $("#startExperiment").removeAttr('disabled');
    $(".button-accept").removeAttr('disabled');
  };


function reciveData(dataRecive, dataActuator, slider, nameActuator){
  var result;
  if (dataActuator == null || nameActuator == "Sun")
    result = dataRecive;
  else 
    result = dataRecive + dataActuator;

  if (result < $(slider).noUiSlider('options').range.min[0]){
    console.log((Math.abs(result) + $(slider).noUiSlider('options').range.min[0]));
    sendActuatorChange(nameActuator, (Math.abs(result) + $(slider).noUiSlider('options').range.min[0]).toString());
    result = $(slider).noUiSlider('options').range.min[0];
    console.log("minimo");
  }
  else{
    if (result > $(slider).noUiSlider('options').range.max[0]){
      console.log($(slider).noUiSlider('options').range.max[0]-result);
      sendActuatorChange(nameActuator, ($(slider).noUiSlider('options').range.max[0]-result).toString());
      result = $(slider).noUiSlider('options').range.max[0];
      console.log("maximo");
    }
  }
  console.log("dentro una vez");
    return result;

}

function finishInitLoading(data){
if (!wsIsReady){
$(".slider-battery").val(data);
actualBattery = data;
$("p#textBattery").text(data + "%");
console.log(wsCameraIsReady);
if (wsCameraIsReady){
myApp.hidePleaseWait();
}
wsIsReady = true;
}
}


/*
function wsclose(event)
{
//   item = document.getElementById("receive");
//  item.firstChild.nodeValue +=  " websocket is closed";
alert("websocket " + event + " is closed");
}
*/

  
/* deprecate */
/*
$(".slider-battery").Link('upper').to('-inline-<div class="tooltipe"></div>', function ( value ) {

  // The tooltip HTML is 'this', so additional
  // markup can be inserted here.
  $(this).html(
    '<span>' + Math.floor(value) + '</span>'
  );
});


$(".slider-battery").Link('lower').to('-inline-<div class="tooltipe"></div>', function ( value ) {

  // The tooltip HTML is 'this', so additional
  // markup can be inserted here.
  $(this).html(
    
       '<span id="muahaha" class="info-pop-up" data-trigger="manual" data-placement="top" tabindex="0" data-toggle="popover" data-content="You can\'t change this value">' + Math.floor(value) + '</span>'
  );
});


$(document).ready(function(){$('.info-pop-up').popover({trigger: 'manual'});
  var a;
  a = $('.slider-battery');
  a = a[0].getElementsByClassName('noUi-handle-lower');
  console.log(a[0]);
});

//console.log( document.getElementsByClassName("slider slider-battery noUi-target noUi-ltr noUi-horizontal noUi-background").id="red");

var cosa1,cosa2,valueBatery;
$('.slider-battery').on(
  "change", function(event){
    a = $('.slider-battery');
    a = a[0].getElementsByClassName('noUi-base');
    $(".slider-battery").val([valueBatery]);
    $(".slider-battery").Link('lower').to(function ( value ) {
  // The tooltip HTML is 'this', so additional
  // markup can be inserted here.
      if (value != valueBatery ){
        clearTimeout(cosa1);
        cosa1 = setTimeout(function(){
          $('#muahaha').popover('show');
          if (cosa2 == null)
            clearTimeout(cosa2);
          cosa2 = setTimeout(function(){
            $('#muahaha').popover('hide');
            cosa2 = null;
          },13000);
        },250);
      }
      else
        if (cosa2 != null)
          $('#muahaha').popover('show');
});
    //$('#muahaha').popover('show');
   
});

function initSliderBattery (){
  a = $('.slider-battery');
  a = a[0].getElementsByClassName("noUi-connect");
  a[0].setAttribute("class","noUi-origin noUi-background");
  setInterval(function () {
    var value = $(".slider-battery").val();
    b = $('.slider-battery');
    a = b[0].getElementsByClassName('noUi-base');
    auxValueBatery = Math.floor((Math.random() * value[1])+1);
    //valueBatery = 10;
    if (auxValueBatery != valueBatery){
      valueBatery = auxValueBatery;
      b.val([valueBatery]);
      if (valueBatery < 10)
        a[0].setAttribute("id", "battery-warning");
      else
        a[0].setAttribute("id", "battery-ok");
    }
  }, 3000);
}
initSliderBattery();
*/

function saveTextAsFile()
{
var textToWrite = "We don't have real data at this time :(. It's comming soon :)";
var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
var fileNameToSaveAs = document.getElementById("inputNameOfFile").value + ".txt";
var browserName=navigator.appName;
if (browserName == "Microsoft Internet Explorer")
{
window.navigator.msSaveBlob(textFileAsBlob, fileNameToSaveAs );
}
else
{
var downloadLink = document.createElement("a");
downloadLink.download = fileNameToSaveAs;
downloadLink.innerHTML = "Download File";
if (window.webkitURL != null)
{
// Chrome allows the link to be clicked
// without actually adding it to the DOM.
downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
}
else
{
// Firefox requires the link to be added to the DOM
// before it can be clicked.
downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
downloadLink.onclick = destroyClickedElement;
downloadLink.style.display = "none";
document.body.appendChild(downloadLink);
}

downloadLink.click();
}
}
function destroyClickedElement(event)
{
  document.body.removeChild(event.target);
}
function battery(){

};

function confirmAccept(){
  var auxLumens, auxHorizontalAxis, auxVerticalAxis;
  auxLumens = getValueRadius("lumens");
  auxVerticalAxis = getValueRadius("verticalAxis");
  auxHorizontalAxis = getValueRadius("horizontalAxis");

  if (auxLumens != null && lumens != auxLumens) 
    sendLumens();
  else
    $(".slider-lumens").val(lumens);

  if (auxVerticalAxis!=null && verticalAxis != auxVerticalAxis) 
    sendVerticalAxis();
  else
    $(".slider-vertical-axis").val(verticalAxis);

  if (auxHorizontalAxis!=null && horizontalAxis != auxHorizontalAxis) 
    sendHorizontalAxis();
  else
    $(".slider-horizontal-axis").val(horizontalAxis);

  sendTime();
  sendJouls();

  sendActuatorChange('ESD', "1");
  cleanForm();
  disable();
};

function getValueRadius(name){
  rads = document.getElementsByName(name);

  var i = 0;
  while (i < rads.length){
      if (rads[i].checked) {
          return rads[i].value;
        }
      i++;
  }
};

function cleanForm(){
  form = document.getElementById('form-confirm-changes');
  form.removeChild(document.getElementById('div-confirm-changes'));
  divForm = document.createElement('div');
  divForm.setAttribute('id', 'div-confirm-changes');
  form.appendChild(divForm);
};



function resetExperiment(){
  enable();
  lumens = null;
  $(".slider-lumens").val(0);
 
  horizontalAxis = null
  $(".slider-horizontal-axis").val(0);
 
  verticalAxis = null;
  $(".slider-vertical-axis").val(0);

  $(".slider-battery").val(10);
  $(".slider-time").val(0);
  //Reset experiment
  varInit.stopTrue();
  sendActuatorChange('SolarLab', "0"); 
  //try this, i don't know if it'll work
  sendActuatorChange('SolarLab', "1"); 
}

function errorLumens(){
  $('#myModalError').modal('show');
};




function realValueToSend(oldNumber, newNumber){
  if (oldNumber==null){
    return newNumber;
  }
  return newNumber - oldNumber;
};

function newForm(id, labelText, newValue, oldValue, name){
  divPrincipal = document.getElementById('div-confirm-changes');
  divForm = document.createElement('form');
  divForm.setAttribute('id', id);
  divForm.setAttribute('class', 'form-group');
  labelForm = document.createElement('label');
  text = document.createTextNode(labelText);
  labelForm.appendChild(text);
  divForm.appendChild(labelForm);
  divForm.appendChild(newRadio(newValue, true, " (New)", name));
  divForm.appendChild(newRadio(oldValue, false, " (Old)", name));
  divPrincipal.appendChild(divForm);
};

function newRadio(value, checked, newOrOld, name){
  divRadio = document.createElement('div');
  divRadio.setAttribute('class', 'radio');
  labelRadio = document.createElement('label');
  input = document.createElement('input');
  input.setAttribute('type', 'radio');
  input.setAttribute('name', name);
  input.setAttribute('value', value);
  
  if (checked){
    input.setAttribute('checked', true);
  }

  labelRadio.appendChild(input);
  text = document.createTextNode(value + newOrOld);
  labelRadio.appendChild(text);
  divRadio.appendChild(labelRadio);
  return divRadio;
};

//fixme
function stopExperiment(){
  sendActuatorChange('ESD', "0");
  //var jsonRequest = JSON.stringify({"method":"getSensorData","sensorId":"ESDval"});
  //ws.send(jsonRequest);
  varInit.stopTrue();
  enable();
};

 var data = [
    [1, 2, 3, 4],
    [1, 2, 3, 4],
    [1, 2, 3, 4],
    [1, 2, 3, 4]
  ];
  
  $('#example1').handsontable({
    data: data,
    colHeaders: ["Time", "Jouls", "Amps", "Volts"],
    maxCols: 4,
    maxRows: 4,
    columns: [
      {readOnly: true,
      },
      {readOnly: true,
      },
      {readOnly: true,
      },
      {readOnly: true,
      }
      ],
  }
   );

  $('#myModalCSV').on('shown.bs.modal', function (e) {
    console.log(document.getElementById("cacaVaca").offsetWidth);
  
});

  $('.slider-battery').on(
  "set", function(event){

    a = $(".slider-battery").val();
    
    // need this for bug in library noUIslider
    if(a == 100){
      a = 100;
    }
    if (a < actualBattery){
      $(".slider-battery").val(actualBattery);
    }

   

});

  
  
    </script>
  </body>
</html>